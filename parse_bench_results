#!/usr/bin/env python

import optparse, fileinput, re, numpy, os.path
from common import *

if __name__ == "__main__":

    parser = optparse.OptionParser(usage = "usage: %prog <space separated list of result directories>\n")
    (options, args) = parser.parse_args()
    resultdirs = set([arg.rstrip("/") for arg in args])
    cluster_results = dict()
    cluster_name_re = re.compile("^(\w+)-\d+")
    resultfiles = find_files(resultdirs, "-name", "HPL.out")
    for resultfile in resultfiles:
        _, _, filedir = os.path.dirname(resultfile).rpartition("/")
        mo = cluster_name_re.match(filedir)
        if mo:
            cluster = mo.group(1)
            if not cluster_results.has_key(cluster):
                cluster_results[cluster] = []
            gflops = []
            for line in fileinput.input(resultfile):
                mo = re.search("^\w+\s+\d+\s+\d+\s+\d+\s+\d+\s+[0-9.]+\s+([0-9.e+-]+)$", line)
                if mo:
                    cluster_results[cluster].append(float(mo.group(1)))

    for cluster in cluster_results:
        print "cluster %s - gflops max = %f" % (cluster, numpy.amax(cluster_results[cluster]))
